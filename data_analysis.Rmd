---
title: "Data Exploration and Data Analysis"
subtitle: "Data Exploration and Implementation of the Workflow in 'WRN helicase is a synthetic lethal target in
microsatellite unstable cancers'"
author: "Martin Brand"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output:
  bookdown::html_document2:
    code_folding: hide
    fig_caption: yes
    number_sections: no
    theme: cerulean
    toc: yes
    toc_depth: 3
    toc_float: yes
    toc_collapsed: yes
    fig_width: 8 
    fig_height: 4 
  bookdown::pdf_document2:
    keep_tex: yes
    fig_caption: yes
    number_sections: no
    toc: yes
    toc_depth: 3
graphics: yes
header-includes:
- \makeatletter\renewcommand*{\fps@figure}{h}\makeatother
- \usepackage{placeins}
geometry: margin=1in
fontsize: 18pt
bibliography: references.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message = FALSE, results="hide", echo=TRUE}
library(ggplot2)
library(readxl)
library(patchwork)
library(tidyverse)
library(caret)
library(reshape2)
library(ggpubr)
library(ggrepel)
library(ggVennDiagram)
library(limma)
library(matrixTests)
library(cowplot)
```

## Preprocessing of the Data
I import the data provided by the authors as "Supplementary Table 1". The data set contains, among other things, the MSI/MSS classifications and the dependency scores for WRN. In addition, I import the data set "DepMap_18Q4_data.rds", which contains all dependency scores from the project Achilles and project DRIVE. The weblinks can all be found in @chan.
```{r, warning=FALSE}
# suppress warning message caused by NA values
data_dir <- "C:/Users/Martin/Documents/Master/Forschungspraktikum/genetic_dependencies_msi/data/"
# read file with MSS/MSI classifications
data_suppl <- read_excel(paste0(data_dir, "supplementary_table.xlsx"))
# transform "NA" strings to NA values
data_suppl[data_suppl=="NA"] <- NA 
# transform numbers saved as strings to numbers
data_suppl <- transform(data_suppl, DRIVE_WRN_D2=as.numeric(DRIVE_WRN_D2), CRISPR_WRN_CERES = as.numeric(CRISPR_WRN_CERES), avg_WRN_dep=as.numeric(avg_WRN_dep))
# delete rows which appear neither in Achilles nor in DRIVE dataset
data_suppl <- data_suppl[!is.na(data_suppl$DRIVE_WRN_D2) | !is.na(data_suppl$CRISPR_WRN_CERES), ]
# delete rows which are classified as intermediate
data_suppl <- data_suppl[data_suppl$CCLE_MSI!="indeterminate", ]
# delete rows which are NA in classification
data_suppl <- data_suppl[!is.na(data_suppl$CCLE_MSI), ]
# read file with dependency scores
data_18Q4 <- read_rds(file.path(data_dir, 'DepMap_18Q4_data.rds'))
dep_scores_18Q4_DRIVE <- data_18Q4[["DRIVE"]]
dep_scores_18Q4_Achilles <- data_18Q4[["CRISPR"]]
```

## Visualization of Classifications
I visualize the number of cell lines classified as MSS and cell lines classified as MSI for both Achilles and DRIVE datasets together and separately. We see that the number of MSS cell lines is many times higher than the number of MSI cell lines.
```{r}
# count rows of MSI and MSS classified cell lines
counts_class <- data.frame(table(data_suppl$CCLE_MSI))

# count rows of MSI and MSS classified cell lines for each dataset separately
counts_class_DRIVE <- data.frame(table(data_suppl[!is.na(data_suppl$DRIVE_WRN_D2),]$CCLE_MSI))
counts_class_Achilles <- data.frame(table(data_suppl[!is.na(data_suppl$CRISPR_WRN_CERES),]$CCLE_MSI))

# create plots
# define limits on y axis
limits <- c(0,600)

bar_chart_total <- ggplot(data=counts_class, aes(x=Var1, y=Freq, fill=Var1)) +
  theme(legend.position = "none") +
  geom_bar(stat = "identity", width = 0.5) +
  ggtitle("Both Datasets in total") +
  labs(x="",y="number of cell lines") +
  coord_cartesian(ylim = limits)

bar_chart_DRIVE <- ggplot(data=counts_class_DRIVE, aes(x=Var1, y=Freq, fill=Var1)) +
  theme(legend.position = "none") +
  geom_bar(stat = "identity", width = 0.5) +
  ggtitle("DRIVE") +
  labs(x="",y="number of cell lines") +
  coord_cartesian(ylim = limits)

bar_chart_Achilles <- ggplot(data=counts_class_Achilles, aes(x=Var1, y=Freq, fill=Var1)) +
  theme(legend.position = "none") +
  geom_bar(stat = "identity", width = 0.5) +
  ggtitle("Achilles") +
  labs(x="",y="number of cell lines") +
  coord_cartesian(ylim = limits)

bar_chart_total + bar_chart_DRIVE + bar_chart_Achilles
```

In the Figure above, we see that the datasets overlap. To determine the size of the overlap, I plot the datasets in a Venn diagram.
```{r}
DRIVE <- data_suppl[!is.na(data_suppl$DRIVE_WRN_D2),]$CCLE_ID
Achilles <- data_suppl[!is.na(data_suppl$CRISPR_WRN_CERES),]$CCLE_ID
all <- list(DRIVE=DRIVE, Achilles=Achilles)
ggVennDiagram(all, label_alpha = 0) +
  ggplot2::scale_fill_gradient(low="lightblue",high = "yellow") +
  theme(legend.position = "none", plot.title = element_text(hjust = 0.5)) +
  ggtitle('Cell Lines in Achilles and DRIVE Dataset')
```

## Correlation of Achilles and DRIVE Dataset
For quality control, I plot the dependency scores of WRN which are present in both datasets against each other. There is a significant correlation, but not as high as I would have expected. For this reason, I decided to analyse the two data sets separately instead of using the mean values. 
```{r}
# extract dependency scores
dep_scores <- data_suppl %>% select(5,6)
# remove rows with NA
dep_scores <- na.omit(dep_scores)
# create scatter plot
ggplot(dep_scores, aes(x=DRIVE_WRN_D2, y=CRISPR_WRN_CERES)) +
  geom_point() + stat_cor() +
  xlab("DRIVE") + ylab("Achilles") +
  ggtitle('Correlation of Dependency Scores')
```

## Dependency Score Distribution in MSI and MSS Cell Lines
I plot the distributions of the dependency scores for WRN in MSS and MSI cells separately as histograms. The dependency scores in MSI cell lines show a significantly greater variance.
```{r}
# create MSI/MSS specific subsets with dependency scores
dep_scores <- data_suppl %>% select(1,4,5,6)
colnames(dep_scores) <- c("CCLE_ID", "CCLE_MSI", "DRIVE", "Achilles")
dep_scores <- melt(data = dep_scores, id.vars = c("CCLE_ID","CCLE_MSI"))
colnames(dep_scores) <- c("CCLE_ID", "CCLE_MSI", "dataset", "dep_score")
dep_scores <- dep_scores[!is.na(dep_scores$dep_score),]
dep_scores_mss <- data.frame(dep_scores[dep_scores$CCLE_MSI=="MSS",])
dep_scores_msi <- data.frame(dep_scores[dep_scores$CCLE_MSI=="MSI",])

# create plots for MSS and MSI cells separately
limits <- c(-3,1) # add limits in x axis

plot_mss <- ggplot(data = dep_scores_mss, aes(x=dep_score, fill=dataset)) +
  geom_histogram(binwidth = 0.2, position = "dodge") +
  coord_cartesian(xlim = limits) +
  xlab("Dependency Score") +
  ggtitle("Dependency Scores in MSS Cells") +
  theme(legend.position="bottom")

plot_msi <- ggplot(data = dep_scores_msi, aes(x=dep_score, fill=dataset)) +
  geom_histogram(binwidth = 0.2, position = "dodge") +
  coord_cartesian(xlim = limits) +
  xlab("Dependency Score") +
  ggtitle("Dependency Scores in MSI Cells") +
  theme(legend.position="bottom")

plot_mss + plot_msi
```

For better understanding, I repeat this step with density plots.
```{r}
plot_mss <- ggplot(data = dep_scores_mss, aes(x=dep_score, color=dataset)) +
  geom_density(linewidth=1, adjust = 0.3) +
  coord_cartesian(xlim = limits) +
  xlab("Dependency Score") +
  ggtitle("Dependency Scores in MSS Cells") +
  theme(legend.position="bottom") +
  geom_vline(xintercept = 0, linetype=2)

plot_msi <- ggplot(data = dep_scores_msi, aes(x=dep_score, color=dataset)) +
  geom_density(linewidth=1, adjust = 0.3) +
  coord_cartesian(xlim = limits) +
  xlab("Dependency Score") +
  ggtitle("Dependency Scores in MSI Cells") +
  theme(legend.position="bottom") +
  geom_vline(xintercept = 0, linetype=2)

plot_mss + plot_msi
```

For better understanding, I repeat this step with box plots and additionally calculate the p-values that are significantly low for both datasets.
```{r}
# extract DRIVE and Achilles data separately with classifications
dep_scores_drive_with_class <- na.omit(data_suppl %>% select(4,5))
dep_scores_achilles_with_class <- na.omit(data_suppl %>% select(4,6))

box_plot_drive <- ggplot(dep_scores_drive_with_class, aes(x = CCLE_MSI, y = DRIVE_WRN_D2, fill = CCLE_MSI)) +
  geom_violin() +
  ggtitle("Boxplot for DRIVE") +
  theme(legend.position = "none") +
  geom_boxplot(outlier.shape = NA, show.legend = F,width = 0.2, position = position_dodge(width = 0.9)) +
  stat_compare_means(method = "wilcox.test") +
  xlab("") + ylab("Dependency Score")

box_plot_achilles <- ggplot(dep_scores_achilles_with_class, aes(x = CCLE_MSI, y = CRISPR_WRN_CERES, fill = CCLE_MSI)) +
  theme(legend.position = "none") +
  geom_violin() +
  ggtitle("Boxplot for Achilles") +
  geom_boxplot(outlier.shape = NA, show.legend = F,width = 0.2, position = position_dodge(width = 0.9)) +
  stat_compare_means(method = "wilcox.test") +
  xlab("") + ylab("Dependency Score")

box_plot_drive + box_plot_achilles
```

## Comparing WRN and ABHD1 Distribution
For comparison, I plot the distributions of dependency scores for a randomly selected KO gene and the WRN gene in the Achilles dataset as histograms. The dependency scores of WRN are generally more broadly distributed. When looking at MSI cell lines, the difference becomes much clearer.
```{r}
# extract dependency scores for ABHD1
ABHD1_dep_scores_Achilles <- data.frame(dep_scores_18Q4_Achilles[,"ABHD1"])

# format dataset and add column for CCLE_ID
ABHD1_dep_scores_Achilles$CCLE_ID <- rownames(ABHD1_dep_scores_Achilles)
colnames(ABHD1_dep_scores_Achilles) <- c("dep_score_ABHD1","CCLE_ID")
rownames(ABHD1_dep_scores_Achilles) <- c()

# extract subset containing CCLE_IDs, dependency scores and MSI/MSS classifications
dep_scores_Achilles <- data_suppl %>% select(1,4,6)

# merge with dependency scores of ABHD1
dep_scores_Achilles <- merge(ABHD1_dep_scores_Achilles, dep_scores_Achilles, by="CCLE_ID")
dep_scores_Achilles <- dep_scores_Achilles[,c(1,3,2,4)]
colnames(dep_scores_Achilles) <- c("CCLE_ID","CCLE_MSI","ABHD1", "WRN")

# melt dataset for better plotting
dep_scores_Achilles <- melt(data = dep_scores_Achilles,id.vars = c("CCLE_ID","CCLE_MSI"))
colnames(dep_scores_Achilles) <- c("CCLE_ID","CCLE_MSI","KD_KO_gene", "dep_score")

# remove rows with NAs
dep_scores_Achilles <- na.omit(dep_scores_Achilles)

# create density plot for MSS cells
plot_mss <- ggplot(data=dep_scores_Achilles[dep_scores_Achilles$CCLE_MSI=="MSS",],aes(x=dep_score, fill=KD_KO_gene)) +
  geom_histogram(binwidth = 0.05, position = "dodge") +
  ggtitle("MSS in Achilles") +
  xlab("Dependency Score") + ylab("counts") +
  theme(legend.position="bottom")

# create density plot for MSI cells
plot_msi <- ggplot(data=dep_scores_Achilles[dep_scores_Achilles$CCLE_MSI=="MSI",],aes(x=dep_score, fill=KD_KO_gene)) +
  geom_histogram(binwidth = 0.05, position = "dodge") +
  ggtitle("MSI in Achilles") +
  xlab("Dependency Score") + ylab("counts") +
  theme(legend.position="bottom")

# plot results
plot_mss + plot_msi
```
I repeat the procedure using box plots and additionally calculate the p-values for comparison. The p-value for WRN is very significant, whereas the p-value for ABHD1 is not.
```{r}
dep_scores_Achilles_WRN <- dep_scores_Achilles[dep_scores_Achilles$KD_KO_gene=="WRN",]
dep_scores_Achilles_ABHD1 <- dep_scores_Achilles[dep_scores_Achilles$KD_KO_gene=="ABHD1",]

box_plot_WRN <- ggplot(dep_scores_Achilles_WRN, aes(x = CCLE_MSI, y = dep_score, fill = CCLE_MSI)) +
  geom_violin() +
  ggtitle("WRN in Achilles") +
  theme(legend.position = "none") +
  geom_boxplot(outlier.shape = NA, show.legend = F,width = 0.2, position = position_dodge(width = 0.9)) +
  stat_compare_means(method = "wilcox.test") +
  ylab("Dependency Score") + xlab("")

box_plot_ABHD1 <- ggplot(dep_scores_Achilles_ABHD1, aes(x = CCLE_MSI, y = dep_score, fill = CCLE_MSI)) +
  theme(legend.position = "none") +
  geom_violin() +
  ggtitle("ABHD1 in Achilles") +
  geom_boxplot(outlier.shape = NA, show.legend = F,width = 0.2, position = position_dodge(width = 0.9)) +
  stat_compare_means(method = "wilcox.test") +
  ylab("Dependency Score") + xlab("")

box_plot_WRN + box_plot_ABHD1
```

# Analysis using Welch-Test
To reproduce the workflow in @chan, I calculate the mean values of the dependency sores for MSI and MSS cell lines separately for every gene.
```{r}
# transform matrix to dataframe
dep_scores_18Q4_Achilles_df <- data.frame(dep_scores_18Q4_Achilles)

# add column with CCLE ID
dep_scores_18Q4_Achilles_df <- cbind(CCLE_ID = rownames(dep_scores_18Q4_Achilles_df), dep_scores_18Q4_Achilles_df)
rownames(dep_scores_18Q4_Achilles_df) <- NULL

# add CCLE_MSI classification to each cell line
classifications <- data_suppl %>% select(1,4)
dep_scores_18Q4_Achilles_df <- merge(dep_scores_18Q4_Achilles_df, classifications, by="CCLE_ID")

# split dataset in MSI and MSS
dep_scores_18Q4_Achilles_msi <- dep_scores_18Q4_Achilles_df[dep_scores_18Q4_Achilles_df$CCLE_MSI=="MSI",c(-1,-ncol(dep_scores_18Q4_Achilles_df))]
dep_scores_18Q4_Achilles_mss <- dep_scores_18Q4_Achilles_df[dep_scores_18Q4_Achilles_df$CCLE_MSI=="MSS",c(-1,-ncol(dep_scores_18Q4_Achilles_df))]

# calculate means
means_msi_Achilles <- data.frame(colMeans(dep_scores_18Q4_Achilles_msi))
means_mss_Achilles <- data.frame(colMeans(dep_scores_18Q4_Achilles_mss))

# merge datasets
means_msi_Achilles$gene <- rownames(means_msi_Achilles)
rownames(means_msi_Achilles) <- NULL
means_mss_Achilles$gene <- rownames(means_mss_Achilles)
rownames(means_mss_Achilles) <- NULL
mean_dep_scores_Achilles <- merge(means_msi_Achilles, means_mss_Achilles, by="gene")
colnames(mean_dep_scores_Achilles) <- c("gene","mean_dep_score_msi","mean_dep_score_mss")

# do the same for DRIVE
dep_scores_18Q4_DRIVE_df <- data.frame(dep_scores_18Q4_DRIVE)
dep_scores_18Q4_DRIVE_df <- cbind(CCLE_ID = rownames(dep_scores_18Q4_DRIVE_df), dep_scores_18Q4_DRIVE_df)
rownames(dep_scores_18Q4_DRIVE_df) <- NULL
dep_scores_18Q4_DRIVE_df <- merge(dep_scores_18Q4_DRIVE_df, classifications, by="CCLE_ID")
dep_scores_18Q4_DRIVE_msi <- dep_scores_18Q4_DRIVE_df[dep_scores_18Q4_DRIVE_df$CCLE_MSI=="MSI",c(-1,-ncol(dep_scores_18Q4_DRIVE_df))]
dep_scores_18Q4_DRIVE_mss <- dep_scores_18Q4_DRIVE_df[dep_scores_18Q4_DRIVE_df$CCLE_MSI=="MSS",c(-1,-ncol(dep_scores_18Q4_DRIVE_df))]
means_msi_DRIVE <- data.frame(colMeans(dep_scores_18Q4_DRIVE_msi, na.rm = TRUE))
colnames(means_msi_DRIVE) <- c("mean_dep_score_msi")
means_mss_DRIVE <- data.frame(colMeans(dep_scores_18Q4_DRIVE_mss, na.rm = TRUE))
colnames(means_mss_DRIVE) <- c("mean_dep_score_mss")
means_msi_DRIVE$gene <- rownames(means_msi_DRIVE)
rownames(means_msi_DRIVE) <- NULL
means_mss_DRIVE$gene <- rownames(means_mss_DRIVE)
rownames(means_mss_DRIVE) <- NULL
mean_dep_scores_DRIVE <- merge(means_msi_DRIVE, means_mss_DRIVE, by="gene")
```

I calculate the p-values of the dependency scores for MSI and MSS cell lines for every gene using the Welch-Test. (Actually, the Welch-Test is not suitable for this data, but I do it for comparison.)
```{r}
test_results_welch_Achilles <- col_t_welch(dep_scores_18Q4_Achilles_msi, dep_scores_18Q4_Achilles_mss)
p_values_welch_Achilles <- data.frame(matrix(NA, nrow = nrow(test_results_welch_Achilles), ncol = 2))
colnames(p_values_welch_Achilles) <- c('gene','p_value')
p_values_welch_Achilles$gene <- rownames(test_results_welch_Achilles)
p_values_welch_Achilles$p_value <- test_results_welch_Achilles$pvalue
head(p_values_welch_Achilles)

test_results_welch_DRIVE <- col_t_welch(dep_scores_18Q4_DRIVE_msi, dep_scores_18Q4_DRIVE_mss)
p_values_welch_DRIVE <- data.frame(matrix(NA, nrow = nrow(test_results_welch_DRIVE), ncol = 2))
colnames(p_values_welch_DRIVE) <- c('gene','p_value')
p_values_welch_DRIVE$gene <- rownames(test_results_welch_DRIVE)
p_values_welch_DRIVE$p_value <- test_results_welch_DRIVE$pvalue
```

I plot the mean differences of the dependency scores in MSI and MSS cell lines against the corresponding p-values. The dependency scores of WRN show a high mean difference and a significant p-value.
```{r}
mean_differences_Achilles <- mean_dep_scores_Achilles
mean_differences_Achilles$mean_dep_score_msi <- NULL
mean_differences_Achilles$mean_dep_score_mss <- NULL
mean_differences_Achilles$difference <- (mean_dep_scores_Achilles$mean_dep_score_msi - mean_dep_scores_Achilles$mean_dep_score_mss)

# transform p-values
p_adj_welch_Achilles <- p_values_welch_Achilles
p_adj_welch_Achilles$p_value <- p.adjust(p_values_welch_Achilles$p_value, method = "hochberg")
p_values_welch_log_Achilles <- p_adj_welch_Achilles
p_values_welch_log_Achilles$p_value <- NULL
p_values_welch_log_Achilles$log <- -log(p_adj_welch_Achilles$p_value)

# create data structure for mean differences and p-values
results_Achilles <- merge(mean_differences_Achilles, p_values_welch_log_Achilles, by="gene")

# define labeled genes
results_Achilles$to_label <- ""
results_Achilles$to_label[results_Achilles$gene == "WRN"] <- "WRN"

# do the same for DRIVE
mean_differences_DRIVE <- mean_dep_scores_DRIVE
mean_differences_DRIVE$mean_msi <- NULL
mean_differences_DRIVE$mean_mss <- NULL
mean_differences_DRIVE$difference <- (mean_dep_scores_DRIVE$mean_dep_score_msi - mean_dep_scores_DRIVE$mean_dep_score_mss)

p_adj_welch_DRIVE <- p_values_welch_DRIVE
p_adj_welch_DRIVE$p_value <- p.adjust(p_values_welch_DRIVE$p_value, method = "hochberg")
p_values_welch_log_DRIVE <- p_adj_welch_DRIVE
p_values_welch_log_DRIVE$p_value <- NULL
p_values_welch_log_DRIVE$log <- -log(p_adj_welch_DRIVE$p_value)

results_DRIVE <- merge(mean_differences_DRIVE, p_values_welch_log_DRIVE, by="gene")

results_DRIVE$to_label <- ""
results_DRIVE$to_label[results_DRIVE$gene == "WRN"] <- "WRN"

# plots
result_plot_Achilles <- ggplot(data=results_Achilles, aes(x=difference, y=log, label=to_label)) +
  geom_point() +
  xlab('MSI–MSS mean difference') +
  ylab('-log(P)') +
  geom_label_repel() +
  ggtitle("Result with Achilles Dataset")

result_plot_DRIVE <- ggplot(data=results_DRIVE, aes(x=difference, y=log, label=to_label)) +
  geom_point() +
  xlab('MSI–MSS mean difference') +
  ylab('-log(P)') +
  geom_label_repel() +
  ggtitle("Result with DRIVE Dataset")

# plot both
result_plot_Achilles
result_plot_DRIVE
# plot_grid(result_plot_Achilles, result_plot_DRIVE, nrow = 2, ncol = 1)
```

## Analysis using Wilcoxon-Test
Again, I calculate the p-values of the dependency scores for MSI and MSS cell lines for every gene, but using the Wilcoxon-Test.
```{r}
# Achilles
test_results_wilc_Achilles <- col_wilcoxon_twosample(dep_scores_18Q4_Achilles_msi, dep_scores_18Q4_Achilles_mss)
p_values_wilc_Achilles <- data.frame(matrix(NA, nrow = nrow(test_results_wilc_Achilles), ncol = 2))
colnames(p_values_wilc_Achilles) <- c('gene','p_value')
p_values_wilc_Achilles$gene <- rownames(test_results_wilc_Achilles)
p_values_wilc_Achilles$p_value <- test_results_wilc_Achilles$pvalue
head(p_values_wilc_Achilles)

# DRIVE
test_results_wilc_DRIVE <- col_wilcoxon_twosample(dep_scores_18Q4_DRIVE_msi, dep_scores_18Q4_DRIVE_mss)
p_values_wilc_DRIVE <- data.frame(matrix(NA, nrow = nrow(test_results_wilc_DRIVE), ncol = 2))
colnames(p_values_wilc_DRIVE) <- c('gene','p_value')
p_values_wilc_DRIVE$gene <- rownames(test_results_wilc_DRIVE)
p_values_wilc_DRIVE$p_value <- test_results_wilc_DRIVE$pvalue
```

Again, I plot the mean differences of the dependency scores in MSI and MSS cell lines against the corresponding p-values. Using the appropriate test method, the p-value for WRN is even higher and the result is therefor more reliable.
```{r}
# transform p-values
p_adj_wilc_Achilles <- p_values_wilc_Achilles
p_adj_wilc_Achilles$p_value <- p.adjust(p_values_wilc_Achilles$p_value, method = "hochberg")
p_values_wilc_log_Achilles <- p_adj_wilc_Achilles
p_values_wilc_log_Achilles$p_value <- NULL
p_values_wilc_log_Achilles$log <- -log(p_adj_wilc_Achilles$p_value)

# create data structure for mean differences and p-values
results_wilc_Achilles <- merge(mean_differences_Achilles, p_values_wilc_log_Achilles, by="gene")

# define labeled genes
results_wilc_Achilles$to_label <- ""
results_wilc_Achilles$to_label[results_wilc_Achilles$gene == "WRN"] <- "WRN"

# do the same for DRIVE
p_adj_wilc_DRIVE <- p_values_wilc_DRIVE
p_adj_wilc_DRIVE$p_value <- p.adjust(p_values_wilc_DRIVE$p_value, method = "hochberg")
p_values_wilc_log_DRIVE <- p_adj_wilc_DRIVE
p_values_wilc_log_DRIVE$p_value <- NULL
p_values_wilc_log_DRIVE$log <- -log(p_adj_wilc_DRIVE$p_value)

results_wilc_DRIVE <- merge(mean_differences_DRIVE, p_values_wilc_log_DRIVE, by="gene")

results_wilc_DRIVE$to_label <- ""
results_wilc_DRIVE$to_label[results_wilc_DRIVE$gene == "WRN"] <- "WRN"

# plots
ggplot(data=results_wilc_Achilles, aes(x=difference, y=log, label=to_label)) +
  geom_point() +
  xlab('MSI–MSS mean difference') +
  ylab('-log(P)') +
  geom_label_repel() +
  ggtitle("Result with Achilles Dataset")

ggplot(data=results_wilc_DRIVE, aes(x=difference, y=log, label=to_label)) +
  geom_point() +
  xlab('MSI–MSS mean difference') +
  ylab('-log(P)') +
  geom_label_repel() +
  ggtitle("Result with DRIVE Dataset")
```

## Analysis using Bayes moderated t-stats
Now I calculate the p-values using Bayes moderated t-stats from limma [@limma] as in @chan and plot them against the corresponding mean differences. With this recommended test method, the result is even more reliable.
```{r}
# calculate p-values
vec_Achilles <- dep_scores_18Q4_Achilles_df$CCLE_MSI
mat_Achilles <- dep_scores_18Q4_Achilles_df
mat_Achilles$CCLE_MSI <- NULL
rownames(mat_Achilles) <- mat_Achilles$CCLE_ID
mat_Achilles$CCLE_ID <- NULL
mat_Achilles <- as.matrix(mat_Achilles)

design_Achilles <- model.matrix(~vec_Achilles)
fit_Achilles <- lmFit(t(mat_Achilles),design=design_Achilles)
fit_Achilles <- eBayes(fit = fit_Achilles)
test_results_bayes_Achilles <- topTable(fit = fit_Achilles, n=Inf, coef = 2, sort.by = "none")

p_adj_bayes_Achilles <- data.frame(matrix(NA, nrow = nrow(test_results_bayes_Achilles), ncol = 2))
colnames(p_adj_bayes_Achilles) <- c('gene','p_adj')
p_adj_bayes_Achilles$gene <- rownames(test_results_bayes_Achilles)
p_adj_bayes_Achilles$p_adj <- test_results_bayes_Achilles$adj.P.Val

# transform p-values
p_adj_bayes_log_Achilles <- p_adj_bayes_Achilles
p_adj_bayes_log_Achilles$p_adj <- NULL
p_adj_bayes_log_Achilles$log <- -log(p_adj_bayes_Achilles$p_adj)

# create data structure for mean differences and p-values
results_bayes_Achilles <- merge(mean_differences_Achilles, p_adj_bayes_log_Achilles, by="gene")

# define labeled genes
results_bayes_Achilles$to_label <- ""
results_bayes_Achilles$to_label[results_bayes_Achilles$gene == "WRN"] <- "WRN"

# do the same with DRIVE
vec_DRIVE <- dep_scores_18Q4_DRIVE_df$CCLE_MSI
mat_DRIVE <- dep_scores_18Q4_DRIVE_df
mat_DRIVE$CCLE_MSI <- NULL
rownames(mat_DRIVE) <- mat_DRIVE$CCLE_ID
mat_DRIVE$CCLE_ID <- NULL
mat_DRIVE <- as.matrix(mat_DRIVE)

design_DRIVE <- model.matrix(~vec_DRIVE)
fit_DRIVE <- lmFit(t(mat_DRIVE),design=design_DRIVE)
fit_DRIVE <- eBayes(fit = fit_DRIVE)
test_results_bayes_DRIVE <- topTable(fit = fit_DRIVE, n=Inf, coef = 2, sort.by = "none")

p_adj_bayes_DRIVE <- data.frame(matrix(NA, nrow = nrow(test_results_bayes_DRIVE), ncol = 2))
colnames(p_adj_bayes_DRIVE) <- c('gene','p_adj')
p_adj_bayes_DRIVE$gene <- rownames(test_results_bayes_DRIVE)
p_adj_bayes_DRIVE$p_adj <- test_results_bayes_DRIVE$adj.P.Val

p_adj_bayes_log_DRIVE <- p_adj_bayes_DRIVE
p_adj_bayes_log_DRIVE$p_adj <- NULL
p_adj_bayes_log_DRIVE$log <- -log(p_adj_bayes_DRIVE$p_adj)

results_bayes_DRIVE <- merge(mean_differences_DRIVE, p_adj_bayes_log_DRIVE, by="gene")

results_bayes_DRIVE$to_label <- ""
results_bayes_DRIVE$to_label[results_bayes_DRIVE$gene == "WRN"] <- "WRN"

# plots
ggplot(data=results_bayes_Achilles, aes(x=difference,y=log, label=to_label)) +
  geom_point() +
  xlab('logFoldChange') +
  ylab('-log(P_adj)') +
  geom_label_repel() +
  ggtitle("Results with Achilles Dataset")

ggplot(data=results_bayes_DRIVE, aes(x=difference,y=log, label=to_label)) +
  geom_point() +
  xlab('logFoldChange') +
  ylab('-log(P_adj)') +
  geom_label_repel() +
  ggtitle("Results with DRIVE Dataset")
```